package br.com.lunacore.ui;

import java.net.MalformedURLException;
import java.util.Comparator;

import com.badlogic.gdx.Gdx;
import com.badlogic.gdx.Input.Buttons;
import com.badlogic.gdx.files.FileHandle;
import com.badlogic.gdx.graphics.g2d.TextureRegion;
import com.badlogic.gdx.scenes.scene2d.InputEvent;
import com.badlogic.gdx.scenes.scene2d.ui.Image;
import com.badlogic.gdx.scenes.scene2d.ui.Tree.Node;
import com.badlogic.gdx.scenes.scene2d.utils.ClickListener;
import com.badlogic.gdx.scenes.scene2d.utils.TextureRegionDrawable;
import com.badlogic.gdx.scenes.scene2d.utils.DragAndDrop.Payload;
import com.badlogic.gdx.scenes.scene2d.utils.DragAndDrop.Source;
import com.kotcrab.vis.ui.widget.MenuItem;
import com.kotcrab.vis.ui.widget.PopupMenu;
import com.kotcrab.vis.ui.widget.VisLabel;
import com.kotcrab.vis.ui.widget.VisTable;
import com.kotcrab.vis.ui.widget.VisTree;

import br.com.lunacore.Editor;
import br.com.lunacore.UIState;
import br.com.lunacore.custom.FileLabel;

public class ClassListUI extends VisTable{
	
	UIState state;
	
	public ClassListUI(UIState state) {
		super();
		this.state = state;
		construct();
	}
	
	public void construct() {
		if(Editor.getInstance().getCurrentProject() != null) {
			final VisTree tree = new VisTree();
			FileHandle proj = Editor.getInstance().getCurrentProject();
			FileLabel lbl = new FileLabel(proj.child("core/src/br/com/lunacore"));
			Node n = new Node(lbl);
			addToTree(proj.child("core/src/br/com/lunacore"), n);
			sortTreeNode(n);
			tree.add(n);
			add(tree).grow();
			
			n.expandAll();
			
			tree.addListener(new ClickListener() {
				
				@Override
				public boolean touchDown(InputEvent event, float x, float y, int pointer, int button) {
					if(button == Buttons.RIGHT) {
						
						final FileLabel lbl = (FileLabel) tree.getSelection().first().getActor();
						if(lbl.getHandle().name().endsWith(".java")) {
							PopupMenu popup = new PopupMenu();
							MenuItem newScene = new MenuItem("Open in editor");
							newScene.addListener(new ClickListener() {
								public void clicked(InputEvent event, float x, float y) {
									if(tree.getSelection().first() != null) {
										Editor.getInstance().openInEclipse(lbl.getHandle());
									}
								};
							});
							popup.addItem(newScene);
							popup.showMenu(getStage(), Gdx.input.getX(), Gdx.graphics.getHeight() - Gdx.input.getY());
							
							event.stop();
						}
					}
					return super.touchDown(event, x, y, pointer, button);
				}
				
				public void clicked(InputEvent event, float x, float y) {
					Node node = tree.getSelection().first();
					if(node != null) {
						final FileLabel label = (FileLabel) node.getActor();
						try {
							
						final Class c = Editor.getInstance().getClassFromFile(label.getHandle());
						
						
						state.setClassSelected(c);
						state.refreshClassProperties();
						
						Editor.getInstance().getDragAndDrop().addSource(new Source(label) {
							public Payload dragStart(InputEvent event, float x, float y, int pointer) {
								try {
									Payload payload = new Payload();
									payload.setObject(c);
										
									VisLabel pl = new VisLabel(c.getCanonicalName());
									pl.getStyle().fontColor.set(1, 0, 0, 1);
									payload.setInvalidDragActor(pl);
									payload.setDragActor(pl);
		
									VisLabel pl2 = new VisLabel(c.getCanonicalName());
									pl2.getStyle().fontColor.set(0, 1, 0, 1);
									payload.setValidDragActor(pl2);
																
									return payload;
								}
								catch(Exception e) {
									e.printStackTrace();
									return new Payload();
								}
							}
							
						});
						
						} catch (ClassNotFoundException e1) {
							e1.printStackTrace();
						} catch (MalformedURLException e1) {
							e1.printStackTrace();
						}
					}
				}
			});
		}
	}
	
	public void addToTree(final FileHandle handle, Node parentNode) {
		for(final FileHandle f : handle.list()) {
			if(f.name().endsWith(".java")) {
				FileLabel lbl = new FileLabel(f);
				Node n = new Node(lbl);
				if(f.isDirectory()) {
					
					
					
					addToTree(f, n);
				}
				parentNode.add(n);
			}
		}
	}
	
	public void sortTreeNode(Node n) {
		n.getChildren().sort(new Comparator<Node>() {
			public int compare(Node o1, Node o2) {
				
				FileLabel fileLabel1 = (FileLabel) o1.getActor();
				FileLabel fileLabel2 = (FileLabel) o2.getActor();

				if(fileLabel1.getHandle().isDirectory() && !fileLabel2.getHandle().isDirectory()) {
					return -1;
				}
				else if(!fileLabel1.getHandle().isDirectory() && fileLabel2.getHandle().isDirectory()) {
					return 1;
				}
				else {
					return fileLabel1.getHandle().name().compareTo(fileLabel2.getHandle().name());
				}
			}
		});
		
		for(Node n2 : n.getChildren()) {
			sortTreeNode(n2);
		}
	}

	public void refresh() {
		clear();
		construct();
	}

}
